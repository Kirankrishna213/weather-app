name: CI Pipeline

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

permissions:
  contents: read
  security-events: write
  pull-requests: write

jobs:
  build-test-scan:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # --------------------------
      # Python setup and tests
      # --------------------------
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.9"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest

      - name: Run tests
        run: pytest -q

      # --------------------------
      # Install Trivy cleanly
      # --------------------------
      - name: Install Trivy
        run: |
          sudo apt-get update -y
          sudo apt-get install wget gnupg lsb-release -y

          wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key \
            | sudo gpg --dearmor -o /usr/share/keyrings/trivy.gpg

          echo "deb [signed-by=/usr/share/keyrings/trivy.gpg] \
            https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main" \
            | sudo tee /etc/apt/sources.list.d/trivy.list > /dev/null

          sudo apt-get update -y
          sudo apt-get install trivy -y

      - name: Create report folder
        run: mkdir -p trivy-report

      # --------------------------
      # Vulnerability Scan + Reachability
      # --------------------------
      - name: Run Trivy filesystem scan
        run: |
          trivy fs . \
            --format json \
            --output trivy-report/fs-report.json \
            --severity HIGH,CRITICAL \
            --scanners vuln,secret,misconfig \
            --reachability

      # --------------------------
      # SBOM
      # --------------------------
      - name: Generate SBOM
        run: |
          trivy sbom . \
            --format cyclonedx \
            --output trivy-report/sbom.xml

      # --------------------------
      # SARIF
      # --------------------------
      - name: Generate SARIF report
        run: |
          trivy fs . \
            --format sarif \
            --output trivy-report/report.sarif

      - name: Upload SARIF to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: trivy-report/report.sarif

      # --------------------------
      # Artifact Upload
      # --------------------------
      - name: Upload Trivy Reports
        uses: actions/upload-artifact@v4
        with:
          name: trivy-report
          path: trivy-report/

      # --------------------------
      # PR Comment with summary
      # --------------------------
      - name: Comment on PR with vulnerability summary
        if: github.event_name == 'pull_request'
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          header: trivy-summary
          message: |
            ### üîç Trivy Scan Summary
            - Vulnerabilities scanned (vuln + secret + misconfig)
            - Reachability analysis included
            - SBOM generat
