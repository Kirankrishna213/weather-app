name: CI-CD Pipeline

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build-test-security:
    runs-on: ubuntu-latest

    steps:
      # ------------------------------
      # Checkout Code
      # ------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # ------------------------------
      # Set up Python
      # ------------------------------
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.9"

      # ------------------------------
      # Install dependencies
      # ------------------------------
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install safety bandit

      # ------------------------------
      # Run tests
      # Fix: Add PYTHONPATH to make app.py importable
      # ------------------------------
      - name: Run pytest
        run: |
          export PYTHONPATH=.
          pytest --maxfail=5 --disable-warnings -v

      # ------------------------------
      # Safety Dependency Check (OWASP-style)
      # Blocks deployment on HIGH/CRITICAL risk
      # ------------------------------
      - name: Run Safety vulnerability scan
        id: safety_scan
        run: |
          echo "Running safety scan..."
          safety check --full-report --output text > safety-report.txt || true

          echo "----- SAFETY REPORT -----"
          cat safety-report.txt

          # Extract HIGH/CRITICAL vulnerabilities
          HIGH_VULS=$(grep -E "CRITICAL|HIGH|CVE" safety-report.txt || true)

          if [ ! -z "$HIGH_VULS" ]; then
              echo "❌ Deployment blocked due to high vulnerabilities:"
              echo "$HIGH_VULS"
              echo "::set-output name=block::true"
          else
              echo "::set-output name=block::false"
          fi

      # ------------------------------
      # Bandit Security Scan
      # ------------------------------
      - name: Run Bandit scan
        run: |
          bandit -r . -f txt -o bandit-report.txt || true
          echo "----- BANDIT REPORT -----"
          cat bandit-report.txt

      # ------------------------------
      # Stop Deployment If Needed
      # ------------------------------
      - name: Stop CD if vulnerabilities found
        run: |
          if [ "${{ steps.safety_scan.outputs.block }}" = "true" ]; then
              echo "❌ High/critical vulnerabilities detected. Stopping pipeline."
              exit 1
          fi

      # ------------------------------
      # Docker build (optional)
      # ------------------------------
      - name: Build Docker image
        run: |
          if [ -f Dockerfile ]; then
            docker build -t weather-app .
          else
            echo "Skipping Docker build — no Dockerfile found."
          fi
