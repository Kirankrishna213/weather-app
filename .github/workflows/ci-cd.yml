name: CI - Security, Tests, SonarQube

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  ci:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout code
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. Set up Python
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: 3.9

      # 3. Install Python dependencies
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest safety

      # 4. Python Security Scan (OWASP Safety)
      - name: OWASP Python Dependency Scan
        run: safety check --full-report

      # 5. Run pytest
      - name: Run pytest
        run: |
          export PYTHONPATH=$PYTHONPATH:$(pwd)
          pytest -vv --maxfail=1 --tb=long

      # 6. Set up Java
      - name: Set up Java
        uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: 17

      # 7. Maven OWASP Dependency Check
      - name: OWASP Dependency Check - Maven
        run: |
          if [ -f pom.xml ]; then
            mvn org.owasp:dependency-check-maven:check
          else
            echo "No pom.xml, skipping Maven dependency check"
          fi

      # 8. Gradle OWASP Dependency Check
      - name: OWASP Dependency Check - Gradle
        run: |
          if [ -f build.gradle ] || [ -f build.gradle.kts ]; then
            ./gradlew dependencyCheckAnalyze
          else
            echo "No Gradle build file, skipping Gradle dependency check"
          fi

      # 9. SonarQube Analysis
      - name: SonarQube Scan
        uses: sonarsource/sonarcloud-github-action@v2
        with:
          projectKey: your-project-key
          organization: your-org
          token: ${{ secrets.SONAR_TOKEN }}
