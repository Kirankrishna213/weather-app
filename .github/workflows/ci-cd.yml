name: CI-CD Pipeline

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build-test-security:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.9"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install safety bandit

      # -------------------------
      # 1. Run Unit Tests
      # -------------------------
      - name: Run Tests
        run: pytest --maxfail=5 --disable-warnings -v

      # -------------------------
      # 2. Run Safety (Vulnerability Scan)
      # -------------------------
      - name: Run Safety Vulnerability Scan
        id: safety_scan
        run: |
          echo "Running Safety vulnerability scan..."
          safety scan -r requirements.txt --json > safety-report.json || true
          echo "SAFETY_REPORT<<EOF" >> $GITHUB_OUTPUT
          cat safety-report.json >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      # -------------------------
      # 3. Fail pipeline only if major (HIGH) vulnerabilities
      # -------------------------
      - name: Check for HIGH vulnerabilities
        run: |
          echo "Checking for HIGH severity vulnerabilities..."
          HIGH_COUNT=$(jq '[.issues[] | select(.severity == "high")] | length' safety-report.json)

          if [ "$HIGH_COUNT" -gt 0 ]; then
              echo "‚ùå Deployment blocked. Found HIGH severity vulnerabilities:"
              jq '.issues[] | select(.severity == "high") | {package_name, affected_versions, cve, description}' safety-report.json
              exit 1
          else
              echo "‚úÖ No HIGH vulnerabilities. Proceeding..."
          fi

      # -------------------------
      # 4. Run Bandit (fail only on HIGH severity issues)
      # -------------------------
      - name: Run Bandit security scan (HIGH only)
        run: |
          bandit -r . -lll -f json -o bandit-report.json || true
          HIGH_BANDIT=$(jq '[.results[] | select(.issue_severity == "HIGH")] | length' bandit-report.json)

          if [ "$HIGH_BANDIT" -gt 0 ]; then
              echo "‚ùå Deployment blocked. HIGH severity issues found in Bandit:"
              jq '.results[] | select(.issue_severity == "HIGH") | {filename, issue_text, severity: .issue_severity}' bandit-report.json
              exit 1
          else
              echo "‚úÖ No HIGH Bandit issues."
          fi

      # -------------------------
      # 5. Deployment (runs only if all above succeeded)
      # -------------------------
      - name: Deploy (only if no major findings)
        if: success()
        run: |
          echo "üöÄ Deployment started..."
          # your deploy script or docker push goes here
          echo "Deployment completed."
